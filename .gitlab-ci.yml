image: node

stages:
  - install
  - build
  - test
  - deploy
  - deployment test

Install Dependencies:
  cache:
    key: $CI_COMMIT_REF_SLUG
    paths:
      - node_modules/
  stage: install
  script:
  - npm install
  artifacts:
    paths:
    - ./node_modules
  
Build Site:
  stage: build
  cache:
    key: $CI_COMMIT_REF_SLUG
  only:
    - master
  script:
    - npm run generate
  artifacts:
    paths:
    - ./dist

Test Artifact:
  image: alpine
  stage: test
  script:
    - grep -q "Michigan" ./dist/index.html

Deploy to Surge:
  stage: deploy
  script:
    - npm install --global surge
    - surge --project ./dist --domain mwpanuxtgitlab.surge.sh

Test Deployment:
  stage: deployment test
  script:
  - curl "mwpanuxtgitlab.surge.sh" | tac | tac | grep -q "Michigan" ./dist/index.html